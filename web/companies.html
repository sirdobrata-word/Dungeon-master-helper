<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–∫–ª–∞–¥ –ö–æ–º–ø–∞–Ω–∏–∏ ‚Äî D&D Service</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .company-card {
      background: linear-gradient(135deg, rgba(20, 10, 5, 0.95) 0%, rgba(10, 5, 2, 0.98) 100%);
      border: 2px solid rgba(139, 0, 0, 0.5);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 
        0 6px 24px rgba(0, 0, 0, 0.8),
        inset 0 0 30px rgba(139, 0, 0, 0.1);
      position: relative;
    }
    
    .company-card::before {
      content: "‚öî";
      position: absolute;
      top: -12px;
      left: 20px;
      font-size: 20px;
      background: #0a0a0a;
      padding: 0 8px;
      color: #d4af37;
    }
    
    .company-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(139, 0, 0, 0.4);
    }
    
    .company-name {
      font-size: 24px;
      font-weight: 700;
      color: #d4af37;
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
      margin: 0;
    }
    
    .company-desc {
      color: #8b7355;
      font-style: italic;
      margin: 8px 0 0;
      font-size: 14px;
    }
    
    .company-actions {
      display: flex;
      gap: 8px;
    }
    
    .company-actions button {
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(139, 0, 0, 0.4);
      color: #8b7355;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .company-actions button:hover {
      background: rgba(139, 0, 0, 0.3);
      color: #d4af37;
      border-color: #d4af37;
    }
    
    .company-actions button.delete:hover {
      background: rgba(139, 0, 0, 0.5);
    }
    
    .company-counts {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
    }
    
    .count-badge {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(139, 0, 0, 0.3);
      border-radius: 6px;
      padding: 10px 16px;
      text-align: center;
      min-width: 100px;
    }
    
    .count-badge .number {
      font-size: 28px;
      font-weight: 700;
      color: #d4af37;
      display: block;
      text-shadow: 0 0 8px rgba(212, 175, 55, 0.4);
    }
    
    .count-badge .label {
      font-size: 11px;
      color: #5a4a3a;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    .company-members {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    @media (max-width: 700px) {
      .company-members {
        grid-template-columns: 1fr;
      }
    }
    
    .members-section {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 8px;
      padding: 14px;
      border: 1px solid rgba(139, 0, 0, 0.3);
    }
    
    .members-section h4 {
      margin: 0 0 12px;
      font-size: 14px;
      color: #8b7355;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-bottom: 1px solid rgba(139, 0, 0, 0.3);
      padding-bottom: 8px;
    }
    
    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      margin-bottom: 6px;
      border: 1px solid rgba(139, 0, 0, 0.2);
    }
    
    .member-item:last-child {
      margin-bottom: 0;
    }
    
    .member-name {
      color: #d4af37;
      font-weight: 500;
    }
    
    .member-info {
      color: #5a4a3a;
      font-size: 12px;
      font-style: italic;
    }
    
    .member-remove {
      background: transparent;
      border: none;
      color: #8b0000;
      cursor: pointer;
      font-size: 16px;
      padding: 2px 6px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    
    .member-remove:hover {
      opacity: 1;
    }
    
    .empty-members {
      color: #5a4a3a;
      font-style: italic;
      font-size: 13px;
      text-align: center;
      padding: 12px;
    }
    
    .add-member-form {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    
    .add-member-form select {
      flex: 1;
      padding: 8px;
      font-size: 12px;
    }
    
    .add-member-form button {
      padding: 8px 14px;
      background: linear-gradient(135deg, #8b0000, #5a0000);
      border: 1px solid rgba(212, 175, 55, 0.3);
      color: #d4af37;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .add-member-form button:hover {
      background: linear-gradient(135deg, #a00000, #6a0000);
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal {
      background: linear-gradient(135deg, rgba(20, 10, 5, 0.98) 0%, rgba(10, 5, 2, 0.99) 100%);
      border: 2px solid rgba(139, 0, 0, 0.6);
      border-radius: 12px;
      padding: 28px;
      width: 90%;
      max-width: 500px;
      box-shadow: 
        0 10px 40px rgba(0, 0, 0, 0.9),
        0 0 40px rgba(139, 0, 0, 0.3);
    }
    
    .modal h3 {
      margin: 0 0 20px;
      color: #d4af37;
      font-size: 22px;
      text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
      border-bottom: 2px solid rgba(139, 0, 0, 0.5);
      padding-bottom: 12px;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    .no-companies {
      text-align: center;
      padding: 60px 20px;
      color: #5a4a3a;
    }
    
    .no-companies .icon {
      font-size: 60px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .no-companies p {
      font-size: 16px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <h1>‚öî –°–∫–ª–∞–¥ –ö–æ–º–ø–∞–Ω–∏–∏ ‚öî</h1>
      <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –≥—Ä—É–ø–ø—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –º–æ–Ω—Å—Ç—Ä–æ–≤ –≤–º–µ—Å—Ç–µ</p>
      <nav style="margin-top: 16px;">
        <a href="index.html" style="color: #8b7355; margin: 0 12px; text-decoration: none;">üé≤ –°–æ–∑–¥–∞–Ω–∏–µ</a>
        <a href="list.html" style="color: #8b7355; margin: 0 12px; text-decoration: none;">üìú –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</a>
        <a href="monsters.html" style="color: #8b7355; margin: 0 12px; text-decoration: none;">üëπ –ú–æ–Ω—Å—Ç—Ä—ã</a>
        <a href="companies.html" style="color: #d4af37; margin: 0 12px; text-decoration: none; font-weight: bold;">‚öî –°–∫–ª–∞–¥</a>
      </nav>
    </header>

    <main class="app-main" style="display: block; max-width: 900px;">
      <!-- –°—Ç–∞—Ç—É—Å –∏ –∫–Ω–æ–ø–∫–∏ -->
      <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <span id="loadStatus" class="status">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <div style="display: flex; gap: 10px;">
          <button class="btn" onclick="loadData()" style="padding: 10px 16px;">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
          </button>
          <button class="btn primary" onclick="showCreateModal()" style="font-size: 14px; padding: 10px 20px;">
            ‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
          </button>
        </div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π -->
      <div id="companiesList">
        <div class="no-companies">
          <div class="icon">‚öî</div>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
    </main>

    <footer class="app-footer">
      D&D Character Sheet Service ‚Äî –°–∫–ª–∞–¥ –ö–æ–º–ø–∞–Ω–∏–∏
    </footer>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <div id="companyModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 id="modalTitle">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</h3>
      <form id="companyForm" class="form">
        <input type="hidden" id="companyId">
        <div class="field">
          <label for="companyName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
          <input type="text" id="companyName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–∏–ª—å–¥–∏—è –ò—Å–∫–∞—Ç–µ–ª–µ–π" required>
        </div>
        <div class="field">
          <label for="companyDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="companyDescription" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn" onclick="hideModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let companies = [];
    let characters = [];
    let monsters = [];
    const statusEl = document.getElementById('loadStatus');

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    async function loadData() {
      statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      statusEl.classList.remove('error');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      const container = document.getElementById('companiesList');
      if (container && companies.length > 0) {
        container.style.opacity = '0.6';
      }
      
      try {
        const [compRes, charRes, monRes] = await Promise.all([
          fetch(`${API_BASE}/companies`).catch(err => {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π:", err);
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:9190");
          }),
          fetch(`${API_BASE}/characters`).catch(() => null),
          fetch(`${API_BASE}/monsters`).catch(() => null)
        ]);
        
        if (!compRes || !compRes.ok) {
          if (!compRes) {
            throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:9190");
          }
          const err = await compRes.json().catch(() => ({}));
          throw new Error(err.error || `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π: ${compRes.status} ${compRes.statusText}`);
        }
        
        companies = await compRes.json();
        characters = charRes ? await charRes.json().catch(() => []) : [];
        monsters = monRes ? await monRes.json().catch(() => []) : [];
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤—ã
        if (!Array.isArray(companies)) {
          console.warn('companies –Ω–µ –º–∞—Å—Å–∏–≤:', companies);
          companies = [];
        }
        if (!Array.isArray(characters)) characters = [];
        if (!Array.isArray(monsters)) monsters = [];
        
        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π:', companies.length, companies);
        
        statusEl.textContent = `–ö–æ–º–ø–∞–Ω–∏–π: ${companies.length} | –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${characters.length} | –ú–æ–Ω—Å—Ç—Ä–æ–≤: ${monsters.length}`;
        renderCompanies();
        
        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        if (container) {
          container.style.opacity = '1';
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
        let errorMessage = err.message;
        
        // –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
        if (errorMessage.includes("Failed to fetch") || errorMessage.includes("NetworkError")) {
          errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:9190";
        } else if (errorMessage.includes("404")) {
          errorMessage = "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:9190";
        }
        
        statusEl.textContent = '–û—à–∏–±–∫–∞: ' + errorMessage;
        statusEl.classList.add('error');
        const container = document.getElementById('companiesList');
        container.innerHTML = `
          <div class="no-companies">
            <div class="icon">‚ö†Ô∏è</div>
            <p>${errorMessage}</p>
            <p style="margin-top: 12px; font-size: 12px;">
              –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π:<br>
              <code style="background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px; margin-top: 8px; display: inline-block;">go run cmd/server/main.go</code>
            </p>
          </div>
        `;
        if (container) {
          container.style.opacity = '1';
        }
      }
    }

    // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π
    function renderCompanies() {
      const container = document.getElementById('companiesList');
      
      if (!companies || companies.length === 0) {
        container.innerHTML = `
          <div class="no-companies">
            <div class="icon">‚öî</div>
            <p>–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = companies.map(comp => `
        <div class="company-card" data-id="${comp.id}">
          <div class="company-header">
            <div>
              <h3 class="company-name">${escapeHtml(comp.name)}</h3>
              ${comp.description ? `<p class="company-desc">${escapeHtml(comp.description)}</p>` : ''}
            </div>
            <div class="company-actions">
              <button onclick="openCompany('${comp.id}')" style="background: linear-gradient(135deg, #8b0000, #5a0000); color: #d4af37; border-color: rgba(212,175,55,0.3);">üëÅÔ∏è –û—Ç–∫—Ä—ã—Ç—å</button>
              <button onclick="editCompany('${comp.id}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
              <button class="delete" onclick="deleteCompany('${comp.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
          <div class="company-counts">
            <div class="count-badge">
              <span class="number">${comp.characterCount || 0}</span>
              <span class="label">–ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π</span>
            </div>
            <div class="count-badge">
              <span class="number">${comp.monsterCount || 0}</span>
              <span class="label">–ú–æ–Ω—Å—Ç—Ä–æ–≤</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è
    function showCreateModal() {
      document.getElementById('modalTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é';
      document.getElementById('companyId').value = '';
      document.getElementById('companyName').value = '';
      document.getElementById('companyDescription').value = '';
      document.getElementById('companyModal').classList.remove('hidden');
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
    async function editCompany(id) {
      try {
        const res = await fetch(`${API_BASE}/companies/${id}`);
        const comp = await res.json();
        
        document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é';
        document.getElementById('companyId').value = comp.id;
        document.getElementById('companyName').value = comp.name;
        document.getElementById('companyDescription').value = comp.description || '';
        document.getElementById('companyModal').classList.remove('hidden');
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏');
      }
    }

    // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    function hideModal() {
      document.getElementById('companyModal').classList.add('hidden');
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
    document.getElementById('companyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      submitBtn.disabled = true;
      
      const id = document.getElementById('companyId').value;
      const name = document.getElementById('companyName').value.trim();
      const description = document.getElementById('companyDescription').value.trim();
      
      if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏!');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
      }
      
      const data = { name, description };

      try {
        const url = id ? `${API_BASE}/companies/${id}` : `${API_BASE}/companies`;
        const method = id ? 'PUT' : 'POST';
        
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', method, url, data);
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        }).catch(fetchError => {
          console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ:', fetchError);
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:9190');
        });

        // –ö–ª–æ–Ω–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        const resClone = res.clone();
        let result;
        
        try {
          result = await res.json();
        } catch (parseErr) {
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON, —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
          const text = await resClone.text();
          console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', text);
          throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${res.status} ${res.statusText}. ${text}`);
        }
        
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', res.status, result);
        
        if (!res.ok) {
          const errorMsg = result.error || result.message || `–û—à–∏–±–∫–∞ ${res.status}: ${res.statusText}`;
          throw new Error(errorMsg);
        }

        hideModal();
        statusEl.textContent = id ? '–ö–æ–º–ø–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ö–æ–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞!';
        statusEl.classList.remove('error');
        
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–ª—è –ª—É—á—à–µ–≥–æ UX
        setTimeout(() => {
          loadData();
        }, 300);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
        let errorMessage = err.message;
        
        // –ë–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
        if (errorMessage.includes("Failed to fetch") || errorMessage.includes("NetworkError")) {
          errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:9190";
        } else if (errorMessage.includes("404")) {
          errorMessage = "–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:9190";
        }
        
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + errorMessage);
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
    async function deleteCompany(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–æ–º–ø–∞–Ω–∏—é?')) return;
      
      try {
        const res = await fetch(`${API_BASE}/companies/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        loadData();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
      }
    }

    // –û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥ –∫–æ–º–ø–∞–Ω–∏–∏
    async function openCompany(id) {
      try {
        const res = await fetch(`${API_BASE}/companies/${id}`);
        const comp = await res.json();
        
        showCompanyDetails(comp);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏');
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–æ–º–ø–∞–Ω–∏–∏
    function showCompanyDetails(comp) {
      const container = document.getElementById('companiesList');
      
      // –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –∏ –º–æ–Ω—Å—Ç—Ä—ã
      const availableChars = characters.filter(c => 
        !comp.characters?.some(cc => cc.id === c.id)
      );
      const availableMons = monsters.filter(m => 
        !comp.monsters?.some(mm => mm.id === m.id)
      );

      container.innerHTML = `
        <div style="margin-bottom: 16px;">
          <button class="btn" onclick="loadData()">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
        </div>
        
        <div class="company-card">
          <div class="company-header">
            <div>
              <h3 class="company-name">${escapeHtml(comp.name)}</h3>
              ${comp.description ? `<p class="company-desc">${escapeHtml(comp.description)}</p>` : ''}
            </div>
          </div>
          
          <div class="company-members">
            <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ -->
            <div class="members-section">
              <h4>üßô –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (${comp.characters?.length || 0})</h4>
              ${comp.characters?.length ? comp.characters.map(c => `
                <div class="member-item">
                  <div>
                    <span class="member-name">${escapeHtml(c.name)}</span>
                    <span class="member-info"> ‚Äî ${c.race} ${c.class}, –£—Ä. ${c.level}</span>
                  </div>
                  <button class="member-remove" onclick="removeCharacter('${comp.id}', '${c.id}')" title="–£–±—Ä–∞—Ç—å">‚úï</button>
                </div>
              `).join('') : '<div class="empty-members">–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</div>'}
              
              ${availableChars.length ? `
                <div class="add-member-form">
                  <select id="addCharSelect">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...</option>
                    ${availableChars.map(c => `<option value="${c.id}">${c.name} (${c.class})</option>`).join('')}
                  </select>
                  <button onclick="addCharacter('${comp.id}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
              ` : ''}
            </div>
            
            <!-- –ú–æ–Ω—Å—Ç—Ä—ã -->
            <div class="members-section">
              <h4>üëπ –ú–æ–Ω—Å—Ç—Ä—ã (${comp.monsters?.length || 0})</h4>
              ${comp.monsters?.length ? comp.monsters.map(m => `
                <div class="member-item">
                  <div>
                    <span class="member-name">${escapeHtml(m.name)}</span>
                    <span class="member-info"> ‚Äî ${m.type}, CR ${m.challengeRating || '?'}</span>
                  </div>
                  <button class="member-remove" onclick="removeMonster('${comp.id}', '${m.id}')" title="–£–±—Ä–∞—Ç—å">‚úï</button>
                </div>
              `).join('') : '<div class="empty-members">–ù–µ—Ç –º–æ–Ω—Å—Ç—Ä–æ–≤</div>'}
              
              ${availableMons.length ? `
                <div class="add-member-form">
                  <select id="addMonsterSelect">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–Ω—Å—Ç—Ä–∞...</option>
                    ${availableMons.map(m => `<option value="${m.id}">${m.name} (${m.type})</option>`).join('')}
                  </select>
                  <button onclick="addMonster('${comp.id}')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –∫–æ–º–ø–∞–Ω–∏—é
    async function addCharacter(companyId) {
      const select = document.getElementById('addCharSelect');
      const characterId = select.value;
      if (!characterId) return;

      try {
        const res = await fetch(`${API_BASE}/companies/${companyId}/characters`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ characterId })
        });

        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        openCompany(companyId);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    // –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏
    async function removeCharacter(companyId, characterId) {
      try {
        const res = await fetch(`${API_BASE}/companies/${companyId}/characters/${characterId}`, {
          method: 'DELETE'
        });

        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        openCompany(companyId);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    // –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω—Å—Ç—Ä–∞ –≤ –∫–æ–º–ø–∞–Ω–∏—é
    async function addMonster(companyId) {
      const select = document.getElementById('addMonsterSelect');
      const monsterId = select.value;
      if (!monsterId) return;

      try {
        const res = await fetch(`${API_BASE}/companies/${companyId}/monsters`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ monsterId })
        });

        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        openCompany(companyId);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    // –£–¥–∞–ª–∏—Ç—å –º–æ–Ω—Å—Ç—Ä–∞ –∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏
    async function removeMonster(companyId, monsterId) {
      try {
        const res = await fetch(`${API_BASE}/companies/${companyId}/monsters/${monsterId}`, {
          method: 'DELETE'
        });

        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        openCompany(companyId);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
    async function checkServer() {
      try {
        const res = await fetch('/healthz');
        if (res.ok) {
          console.log('–°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω');
          return true;
        }
      } catch (err) {
        console.error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', err);
        statusEl.textContent = '‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:9190';
        statusEl.classList.add('error');
        document.getElementById('companiesList').innerHTML = `
          <div class="no-companies">
            <div class="icon">‚ö†Ô∏è</div>
            <p>–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π:<br><code style="background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 4px; margin-top: 8px; display: inline-block;">go run cmd/server/main.go</code><br>–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:9190</p>
          </div>
        `;
        return false;
      }
      return false;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    checkServer().then(serverOk => {
      if (serverOk) {
        loadData();
      }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏)
    window.addEventListener('focus', () => {
      checkServer().then(serverOk => {
        if (serverOk) {
          loadData();
        }
      });
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ URL –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('refresh') === 'true') {
      checkServer().then(serverOk => {
        if (serverOk) {
          loadData();
        }
      });
      // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  </script>
</body>
</html>

